<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Karte Ebelsberg 1809 (URL-Version)</title>

<link rel="stylesheet" href="../../style/map.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  .my-location {
    width: 12px;
    height: 12px;
    background: blue;
    border-radius: 50%;
    border: 2px solid white;
  }
  #next-button { display: none; }
</style>
</head>
<body>

<h1 id="map-title">Karte Ebelsberg 1809</h1>
<div id="speech"></div>
<div id="map"></div>
<button id="next-button" class="button bottom-right">Ziel erreicht! Weiter</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// --- Parameter aus URL lesen ---
const params = new URLSearchParams(window.location.search);
const zielStr = params.get("ziel"); // "lat,lng"
const iconFile = params.get("icon");
const zielText = params.get("text") || "";
const nextUrl = params.get("next");

if (!zielStr || !iconFile || !nextUrl) {
  alert("Fehler: Unvollständige URL-Parameter!");
}

const [zielLat, zielLng] = zielStr.split(",").map(Number);

// --- Spielfeld-Bounds ---
const bounds = L.latLngBounds(
  [48.24359755374813, 14.324905196694772],
  [48.24793531162874, 14.333512031428347]
);

// --- Map erstellen ---
const map = L.map('map', {
  maxBounds: bounds,
  maxBoundsViscosity: 1.0,
  zoomControl: true
});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors',
  minZoom: 16,
  maxZoom: 19
}).addTo(map);
map.fitBounds(bounds);

// --- Zielmarker setzen ---
const zielKoordinate = L.latLng(zielLat, zielLng);
const zielIcon = L.icon({
  iconUrl: `../../icons/${iconFile}`,
  iconSize: [25, 25],
  iconAnchor: [15, 20]
});
L.marker(zielKoordinate, { icon: zielIcon }).addTo(map);

// --- Standortüberwachung ---
let locationMarker = null;
let hasValidPosition = false;
let hasAlertedOutOfBounds = false;

function checkPosition(position) {
  const userLatLng = L.latLng(position.coords.latitude, position.coords.longitude);
  const distance = userLatLng.distanceTo(zielKoordinate);

  if (!locationMarker) {
    const myIcon = L.divIcon({ className: 'my-location' });
    locationMarker = L.marker(userLatLng, { icon: myIcon }).addTo(map);
  } else {
    locationMarker.setLatLng(userLatLng);
  }

  hasValidPosition = true;

  if (!bounds.contains(userLatLng) && !hasAlertedOutOfBounds) {
    alert("⚠️ Du bist außerhalb des Spielfelds!");
    hasAlertedOutOfBounds = true;
  }
  if (bounds.contains(userLatLng)) {
    hasAlertedOutOfBounds = false;
  }

  if (distance < 10) {
    document.getElementById('next-button').style.display = 'block';
    document.getElementById('speech').innerText = zielText;
  } else {
    document.getElementById('next-button').style.display = 'none';
    document.getElementById('speech').innerText = "Bewege dich zum Zielpunkt";
  }
}

function errorPosition(err) {
  hasValidPosition = false;
  document.getElementById('next-button').style.display = 'none';
  document.getElementById('speech').innerText =
    "⚠️ GPS-Fehler: " + err.message + " – Bitte Standort aktivieren.";
}

if (navigator.geolocation) {
  navigator.geolocation.watchPosition(
    checkPosition,
    errorPosition,
    { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
  );
} else {
  alert("GPS wird nicht unterstützt.");
}

// --- Weiter-Button ---
document.getElementById('next-button').addEventListener('click', function(e) {
  if (!hasValidPosition) {
    e.preventDefault();
    alert("Du musst zuerst deinen Standort aktivieren!");
  } else {
    window.location.href = nextUrl;
  }
});
</script>
</body>
</html>
