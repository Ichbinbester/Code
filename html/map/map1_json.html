<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Karte Ebelsberg 1809</title>

<link rel="stylesheet" href="../../style/map.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  .my-location {
    width: 12px; height: 12px;
    background: blue; border-radius: 50%;
    border: 2px solid white;
  }
  #next-button { display: none; }
</style>
</head>
<body>

<h1 id="map-title">Karte Ebelsberg 1809</h1>
<div id="speech"></div>
<div id="map"></div>
<button id="next-button" class="button bottom-right">Ziel erreicht! Weiter</button>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// ---- URL-Parameter auslesen ----
const params = new URLSearchParams(window.location.search);
const mapId = params.get("id");
if (!mapId) {
  alert("Fehler: Keine Map-ID angegeben!");
}

// ---- Spielfeld-Bounds ----
const bounds = L.latLngBounds(
  [48.24359755374813, 14.324905196694772], // Südwest
  [48.24793531162874, 14.333512031428347]  // Nordost
);

// ---- Map erstellen ----
const map = L.map('map', {
  maxBounds: bounds,
  maxBoundsViscosity: 1.0,
  zoomControl: true
});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors',
  minZoom: 16,
  maxZoom: 19
}).addTo(map);
map.fitBounds(bounds);

// ---- Map-Konfig laden ----
fetch("maps.json")
  .then(res => res.json())
  .then(configList => {
    const config = configList.find(m => m.id === mapId);
    if (!config) {
      alert("Fehler: Map-ID nicht gefunden!");
      return;
    }

    const zielKoordinate = L.latLng(config.ziel[0], config.ziel[1]);
    const zielIcon = L.icon({
      iconUrl: `../../icons/${config.icon}`,
      iconSize: [25, 25],
      iconAnchor: [15, 20]
    });
    L.marker(zielKoordinate, { icon: zielIcon }).addTo(map);

    let locationMarker = null;
    let hasValidPosition = false;
    let hasAlertedOutOfBounds = false;

    function checkPosition(position) {
      const userLatLng = L.latLng(position.coords.latitude, position.coords.longitude);
      const distance = userLatLng.distanceTo(zielKoordinate);

      if (!locationMarker) {
        const myIcon = L.divIcon({ className: 'my-location' });
        locationMarker = L.marker(userLatLng, { icon: myIcon }).addTo(map);
      } else {
        locationMarker.setLatLng(userLatLng);
      }

      hasValidPosition = true;

      if (!bounds.contains(userLatLng) && !hasAlertedOutOfBounds) {
        alert("⚠️ Du bist außerhalb des Spielfelds!");
        hasAlertedOutOfBounds = true;
      }
      if (bounds.contains(userLatLng)) {
        hasAlertedOutOfBounds = false;
      }

      if (distance < 10) {
        document.getElementById('next-button').style.display = 'block';
        document.getElementById('speech').innerText = config.text;
      } else {
        document.getElementById('next-button').style.display = 'none';
        document.getElementById('speech').innerText = "Bewege dich zum Zielpunkt";
      }
    }

    function errorPosition(err) {
      hasValidPosition = false;
      document.getElementById('next-button').style.display = 'none';
      document.getElementById('speech').innerText =
        "⚠️ GPS-Fehler: " + err.message + " – Bitte Standort aktivieren.";
    }

    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        checkPosition,
        errorPosition,
        { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
      );
    } else {
      alert("GPS wird nicht unterstützt.");
    }

    document.getElementById('next-button').addEventListener('click', function(e) {
      if (!hasValidPosition) {
        e.preventDefault();
        alert("Du musst zuerst deinen Standort aktivieren!");
      } else {
        window.location.href = config.next;
      }
    });
  })
  .catch(err => {
    console.error("Fehler beim Laden der Map-Konfiguration:", err);
  });
</script>
</body>
</html>
